name: CI/CD Terraform & App 

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  RESOURCE_GROUP: rg-mini-spotify
  ACR_NAME: ${{ secrets.ACR_NAME }}
  APP_NAME: ${{ secrets.APP_NAME }}

jobs:
  infra-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    defaults: { run: { shell: bash } }
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with: 
          terraform_version: '1.5.0'
          
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          
      - name: Terraform Init
        working-directory: infra
        run: terraform init
        
      - name: Terraform Format Check
        working-directory: infra
        run: terraform fmt -check
        continue-on-error: true
        
      - name: Terraform Validate
        working-directory: infra
        run: terraform validate
        
      - name: Terraform Plan
        working-directory: infra
        run: terraform plan -out=plan.tfplan

  infra-apply:
    name: Terraform Apply (manual)
    runs-on: ubuntu-latest
    needs: infra-plan
    if: github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
      
      - uses: hashicorp/setup-terraform@v2
        with: 
          terraform_version: '1.5.0'
          
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          
      - name: Terraform Init
        working-directory: infra
        run: terraform init
        
      - name: Terraform Apply
        working-directory: infra
        run: terraform apply -auto-approve

  app-build-and-deploy:
    name: Build, Push, Deploy App
    runs-on: ubuntu-latest
    needs: infra-plan
    steps:
      - uses: actions/checkout@v4
      
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
        
      - name: Login to ACR
        run: az acr login --name ${{ secrets.ACR_NAME }}
        
      - name: Build and Push Docker Image
        id: build_and_push
        run: |
          IMAGE_TAG=${{ github.run_id }}
          IMAGE_NAME="${{ secrets.ACR_NAME }}.azurecr.io/music-backend:${IMAGE_TAG}"
          
          docker build -t $IMAGE_NAME backend/
          docker push $IMAGE_NAME
          
          echo "image=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          
      - name: Update App Service Container
        run: |
          az webapp config container set \
            -g ${{ env.RESOURCE_GROUP }} \
            -n ${{ secrets.APP_NAME }} \
            --docker-custom-image-name "${{ steps.build_and_push.outputs.image }}" \
            --docker-registry-server-url "https://${{ secrets.ACR_NAME }}.azurecr.io"
            
      - name: Restart App Service
        run: |
          az webapp restart \
            -g ${{ env.RESOURCE_GROUP }} \
            -n ${{ secrets.APP_NAME }}
            
      - name: Wait for App Service
        run: sleep 30
        
      - name: Run Smoke Tests
        run: |
          chmod +x scripts/smoke-test.sh
          ./scripts/smoke-test.sh https://${{ secrets.APP_NAME }}.azurewebsites.net
